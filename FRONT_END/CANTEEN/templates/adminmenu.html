<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Staff Menu</title>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
body {
    font-family: Arial, sans-serif;
    margin: 0; padding: 20px;
    background: url('../static/assets/menupage1.jpeg') no-repeat center center fixed;
    background-size: cover;
}
.container {
    max-width: 900px; margin: auto;
    background: rgba(255,255,255,0.95);
    padding: 20px; border-radius: 10px;
    box-shadow: 0 0 15px rgba(0,0,0,0.2);
}
h1,h2 { text-align: center; color: #222; }
table { width: 100%; border-collapse: collapse; margin-bottom: 20px; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 6px rgba(0,0,0,0.2); background: #111; color: #fff; }
th, td { padding: 12px; text-align: center; border-bottom: 1px solid #444; }
th { background: #222; color: #ffcc00; }
td img { width: 50px; height: 50px; object-fit: cover; border-radius: 50%; }
input[type="number"] { width: 70px; padding: 4px; text-align: center; border-radius: 4px; border: 1px solid #ccc; }
button { padding: 6px 12px; border: none; border-radius: 5px; cursor: pointer; }
button.add-btn { background: #4CAF50; color: white; }
button.delete-btn { background: #f44336; color: white; }
button.view-orders { background: #9C27B0; color: white; margin-top: 10px; }
form { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-bottom: 20px; }
input[type="text"], input[type="file"] { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
label { display: block; font-weight: bold; margin-top: 5px; }
input[disabled] {
  background: transparent;   
  color: #ffcc00;         
  border: none;             
  font-weight: bold;
}


</style>
</head>
<body>

<div class="container">
<h1>Staff Menu</h1>

<table>
<thead>
<tr>
<th>Photo</th>
<th>Name</th>
<th>Price & Quantity</th>
<th>Show in Menu</th>
<th>Actions</th>
</tr>
</thead>
<tbody id="menuBody"></tbody>
</table>

<h2>Add New Dish</h2>
<form id="addDishForm">
<label for="newPhoto">Dish Photo:</label>
<input type="file" id="newPhoto" name="photo" accept="image/*" required>

<label for="newName">Dish Name:</label>
<input type="text" id="newName" name="dishname" placeholder="Enter dish name" required>

<label for="newRate">Price (₹):</label>
<input type="number" id="newRate" name="price" placeholder="Enter price" required min="0">

<label for="newQuantity">Quantity:</label>
<input type="number" id="newQuantity" name="quantity" placeholder="Enter quantity" required min="0">

<label>
  <input type="checkbox" id="newAvailable" name="available"> Show in Student Menu
</label>

<button type="submit" class="add-btn">Add Dish</button>
</form>

<button class="view-orders" onclick="viewOrders()">View Orders</button>
<div id="ordersContainer"></div>

</div>

<script>
let dishes = [];
const menuBody = document.getElementById("menuBody");
const addDishForm = document.getElementById("addDishForm");
const ordersContainer = document.getElementById("ordersContainer");

// Fetch all dishes
async function fetchDishes(){
    try{
        const res = await fetch('/dishes/');
        dishes = await res.json();
        renderMenu();
    }catch(err){ console.error(err); }
}


function renderMenu(){
    menuBody.innerHTML = "";
    dishes.forEach((dish) => {
        const row = document.createElement("tr");
        row.innerHTML = `
            <td><img src="${dish.photo}" alt="${dish.dishname}"></td>
            <td>${dish.dishname}</td>
            <td>
                <input type="number" id="price-${dish.id}" value="${dish.price}" min="0" disabled> ₹ | 
                <input type="number" id="qty-${dish.id}" value="${dish.quantity}" min="0" disabled>
            </td>
            <td>
                <input type="checkbox" ${dish.available ? "checked" : ""} onchange="toggleAvailability('${dish.id}', this.checked)">
            </td>
            <td>
                <button onclick="enableEdit('${dish.id}', this)">Edit</button>
                <button class="delete-btn" onclick="deleteDish('${dish.id}')">Delete</button>
            </td>
        `;
        menuBody.appendChild(row);
    });
}

async function enableEdit(dishId, btn){
    const priceInput = document.getElementById(`price-${dishId}`);
    const qtyInput = document.getElementById(`qty-${dishId}`);

    if(priceInput.disabled){
        
        priceInput.disabled = false;
        qtyInput.disabled = false;
        btn.textContent = "Save";
    } else {
    
        await updateDish(dishId, "price", priceInput.value);
        await updateDish(dishId, "quantity", qtyInput.value);

        priceInput.disabled = true;
        qtyInput.disabled = true;
        btn.textContent = "Edit";

        Swal.fire("Updated!", "Dish details updated.", "success");
    }
}




addDishForm.addEventListener("submit", async (e)=>{
    e.preventDefault();
    const file = document.getElementById("newPhoto").files[0];
    let photoURL = "";
    if(file){ 
        const reader = new FileReader();
        reader.readAsDataURL(file);
        await new Promise(res => reader.onload = res);
        photoURL = reader.result;
    }

    const newDish = {
        dishname: document.getElementById("newName").value,
        price: parseFloat(document.getElementById("newRate").value),
        quantity: parseInt(document.getElementById("newQuantity").value),
        available: document.getElementById("newAvailable").checked,
        photo: photoURL
    };

    try{
        const res = await fetch('/dishes/', {
            method:"POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify(newDish)
        });
        const createdDish = await res.json();
        dishes.push(createdDish);
        renderMenu();
        addDishForm.reset();
        Swal.fire('Added!', 'Dish has been added.', 'success');
    }catch(err){ console.error(err); Swal.fire('Error', 'Failed to add dish', 'error'); }
});


async function deleteDish(dishId){
    if(!dishId) return;
    Swal.fire({
        title: 'Are you sure?',
        text: "This dish will be permanently deleted!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Yes, delete it!'
    }).then(async (result) => {
        if (result.isConfirmed) {
            try{
                await fetch(`/dishes/${dishId}`, { method:"DELETE" });
                dishes = dishes.filter(d => d.id !== dishId);
                renderMenu();
                Swal.fire('Deleted!', 'Dish has been deleted.', 'success');
            }catch(err){ console.error(err); Swal.fire('Error', 'Failed to delete dish', 'error'); }
        }
    });
}


async function updateDish(dishId, field, value){
    const payload = {};
    payload[field] = field==="price"? parseFloat(value) : parseInt(value);
    if(payload[field] < 0){ Swal.fire('Error', `${field} must be >= 0`); return; }

    try{
        await fetch(`/dishes/${dishId}`, {
            method:"PUT",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify(payload)
        });
        const dish = dishes.find(d => d.id===dishId);
        if(dish) dish[field] = payload[field];
    }catch(err){ console.error(err); Swal.fire('Error', 'Failed to update dish', 'error'); }
}


async function toggleAvailability(dishId, value){
    try{
        await fetch(`/dishes/${dishId}`, {
            method:"PUT",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({ available: value })
        });
        const dish = dishes.find(d => d.id===dishId);
        if(dish) dish.available = value;
    }catch(err){ console.error(err); Swal.fire('Error', 'Failed to update availability', 'error'); }
}


function viewOrders() {
    window.location.href = '/order/orders'; 
}

window.onload = fetchDishes;
</script>

</body>
</html>
