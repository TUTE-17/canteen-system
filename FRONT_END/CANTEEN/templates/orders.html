<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Orders (Supabase)</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  body {
    min-height: 100vh; 
    display: flex; 
    justify-content: center; 
    align-items: flex-start; 
    background: #f3f4f6; 
    font-family: sans-serif;
    padding: 20px;
  }

  .page-container {
    width: 100%; 
    max-width: 1200px;
    display: flex; 
    flex-direction: column; 
    align-items: center;
  }

  .header {
    width: 100%;
    position: relative;
    margin-bottom: 20px;
  }

  .header h1 {
    text-align: center;
    font-size: 2rem;
    font-weight: bold;
  }

  .back-btn {
    position: absolute;
    left: 0;
    top: 50%;
    transform: translateY(-50%);
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    border-radius: 6px;
    background: #f3f4f6;
    color: #111;
    font-weight: 500;
    cursor: pointer;
    transition: 0.2s;
  }
  .back-btn:hover {
    background: #e5e7eb;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  }

  .order-card { 
    background: white; padding: 20px; border-radius: 14px; 
    box-shadow: 0 4px 10px rgba(0,0,0,0.15); cursor: pointer; 
    transition: 0.2s; min-height: 160px; width: 280px;
  }
  .order-card:hover { box-shadow: 0 6px 16px rgba(0,0,0,0.25); }
  .student-block { 
    font-weight: bold; margin-bottom: 8px; background: #E5E7EB; 
    padding: 10px; border-radius: 8px; display: flex; 
    justify-content: space-between; align-items: center; 
  }
  .item-list { margin-top: 10px; display: none; list-style: disc; padding-left: 20px; }
  .tick-btn { 
    margin-top: 12px; padding: 8px 14px; background: #10B981; 
    color: white; border-radius: 8px; cursor: pointer; 
  }
  .tick-btn:hover { background: #059669; }
  .status { font-weight: 600; color: #1F2937; margin-left: 10px; }

  
  .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); 
           display: flex; align-items: center; justify-content: center; }
  .modal-content { background: white; padding: 20px; border-radius: 12px; 
                   text-align: center; width: 320px; }
  .modal-btn { margin: 10px; padding: 8px 14px; border-radius: 8px; cursor: pointer; }
  .confirm { background: #EF4444; color: white; }
  .confirm:hover { background: #DC2626; }
  .cancel { background: #E5E7EB; }
  .cancel:hover { background: #D1D5DB; }
</style>
</head>
<body>

<div class="page-container">
  
  <div class="header">
    <h1>ORDERS</h1>
    <button class="back-btn" onclick="goBack()">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
      </svg>
      Back
    </button>
  </div>

  
  <div id="orderContainer" class="flex flex-wrap justify-center gap-6"></div>
</div>


<div id="confirmModal" class="modal hidden">
  <div class="modal-content">
    <h2 class="text-lg font-bold mb-4">Confirm Deletion</h2>
    <p class="mb-4">Are you sure you want to delete this order?</p>
    <button id="confirmYes" class="modal-btn confirm">Yes, Delete</button>
    <button id="confirmNo" class="modal-btn cancel">Cancel</button>
  </div>
</div>

<script>
const container = document.getElementById('orderContainer');
const modal = document.getElementById('confirmModal');
const confirmYes = document.getElementById('confirmYes');
const confirmNo = document.getElementById('confirmNo');
let currentOrderId = null;


function goBack() { history.back(); }

async function loadOrders() {
  try {
    const res = await fetch('/order/list');
    const orders = await res.json();
    container.innerHTML = '';

    orders.forEach(order => {
      const studentId = order.student?.reg_no || 'N/A';
      const items = order.items || [];

      const card = document.createElement('div');
      card.className = 'order-card';
      card.innerHTML = `
        <div class="student-block">
          <span>Reg No: ${studentId}</span>
          <span>Total: ₹${order.price}</span>
        </div>
        <div class="status">Status: ${order.status || 'Pending'}</div>
        <ul class="item-list">
          ${items.length > 0
            ? items.map(i => `<li>${i.dishname} x${i.quantity} – ₹${i.price}</li>`).join('')
            : '<li>No items found</li>'
          }
        </ul>
        <button class="tick-btn">✓ Confirm Order</button>
      `;

      const itemList = card.querySelector('.item-list');
      const tickBtn = card.querySelector('.tick-btn');

      card.addEventListener('click', (e) => {
        if(e.target !== tickBtn) itemList.style.display = itemList.style.display === 'block' ? 'none' : 'block';
      });

      tickBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        currentOrderId = order.id;
        modal.classList.remove('hidden');
      });

      container.appendChild(card);
    });
  } catch(err) { console.error('Error loading orders:', err); }
}


confirmYes.addEventListener('click', async () => {
  if(currentOrderId) {
    try {
      const res = await fetch(`/order/delete/${currentOrderId}`, { method: 'DELETE' });
      const data = await res.json();
      if(data.success) {
        modal.classList.add('hidden');
        loadOrders();
      } else { alert('Failed to delete order'); }
    } catch(err) { console.error(err); }
  }
});
confirmNo.addEventListener('click', () => { modal.classList.add('hidden'); });


loadOrders();
</script>
</body>
</html>
